#!/usr/bin/env python3
"""Synchronous test script for comparing entity extraction quality"""

import sys
from pathlib import Path
import pandas as pd
import asyncio

# Add src to path
sys.path.append(str(Path(__file__).parent / "src"))

from src.config import ConfigManager
from src.pipeline import EntityExtractor
from src.pipeline.enhanced_entity_extractor import EnhancedEntityExtractor


def test_quality_comparison():
    """Compare quality of standard vs enhanced entity extraction"""
    
    # Test dialog from your example
    test_dialog = """Оператор: А здравствуйте, меня зовут меня зовут Татьяна клетка менеджер по работе с клиентами компании Avito звоню по вашему профилю алмаз, а как могу к вам обращаться.
Клиент: Да да да слушаю.
Оператор: А как алмаз, можно с вами говорить да.
Клиент: Да-да-да.
Оператор: Анна очень приятно позвоню обсудить ваши размещение на Avito и помочь увеличить продажи с помощью нашей площадке удобно обсудить этот вопрос.
Клиент: Да да да.
Оператор: А спасибо, а я правильно понимаю что вы являетесь руководителем данного профиля.
Клиент: Ну да я услугой 1 человек.
Оператор: Это ваш владелец короче хорошо пока открывается вашем профиле подскажите а как вообще детей работать с вашим профилем какую-то продвижению развития вообще что-то делаете.
Клиент: Нет-нет ничего не ну я пробовал в принципе ничего не помогает ничего не работает разницы нет.
Оператор: Ага просто подключайте выкладываете объявление и всё да.
Клиент: Да.
Оператор: Хорошо. Ну а самое главное мама скажите как дела обстоят с продажами.
Клиент: Ну, более менее хватает.
Оператор: То есть система найдите.
Клиент: Как как было хотя бы его.
Оператор: Ага то есть есть в любом случае а мы на Avito видел что у вас есть и потенциальные роста что есть и контакты и а на просмотрах, а то есть вот вы сказали ничего не используете ну я вижу у вас активных объявление 14 6 из которых подключена под застройку ценой целевого действия а здесь вам всё понятно как это работает того.
Клиент: Да да да всё понятно всё, проблем нет.
Оператор: А да вот у вас подключён на тут там на 9 рублей его обходите только 7 процентов на конкурентов, я вам знаете как камни могу просто как стратегию мне предложить. Попробовать а вот там оставите 1 объявление под настройку цены целевого действия остальные отключить на время но поставить его чтобы оно было в топе. Я вам не предлагаю вы знаете как о, обогнать 100 процентников быть на 1м 2м листе но попробуйте своё объявление, поднятие его повыше, а чтобы а но знаете как не ведь мы тоже с вами покупать, и когда. Забили любой товар неважно какой, нам вы высвечивается несколько страниц мы посмотрели там 5 6 7 страниц все мы определились и с цветом и с количеством и датой вот попробуйте а поднятие 1 объявление где-то из практики это 40 50 процентов конкурентов чтобы вы обгоняли, на 5 7 дней как только у вас прямо начинает там увеличиваться просмотры сделке продажи всё вы заходите на это объявление и отключаете данную услугу а другое объявление вот таким вот образом поднимаете. Я понятно. Выразилась а у вас.
Клиент: А продвигать как с помощью там продвижение или с помощью просто сколько там объявление стоит допустим во сколько там минималка 4 рубля там просто к вам увеличить.
Оператор: Нет то что то что у вас на у вас подключено я вам не предлагаю увеличить сумму утра я вам предлагаю её просто перераспределить. Вот оставить 1 объявление вот как я вам рассказала как его можно приподнять, и посмотреть вот как только вы поймёте поймёте как эта услуга работает.
Клиент: Я уже до этого делал так как вы обещали то есть сумма увеличилась.
Оператор: Ага алмаз да и.
Клиент: На вопрос с баланса с бесконечными просто извините что меняется вы самом деле.
Оператор: А то есть реальная здесь не не прошла не увеличение не не не стали больше звонить писать звонков по то есть а и продаж не было.
Клиент: Я вас ждать пытался и так. Ну было но я бы не сказал что даже то есть примерно тоже самое выходит я говорю не сказал что стоит тратить на это.
Оператор: Э ну ой.
Клиент: Нет такое бывало что у меня там по 1000 рублей в день всегда вот даже и как бы я не пользование получал то что у меня там куча стоял большая сумма вставил.
Оператор: Ага алмаз но очень странно вот спросить.
Клиент: Тут такое объявление просто люди заинтересуются и потом кто хочется хочется нет-нет может у кого-то там это получается но моих случае да.
Оператор: Ага ну вот я Пьём да некоторые позиции прямо вот я смотрю и ведь и просмотров у вас нет вот место металлочерепица. Терракотовый 80 04 тут вообще сейчас посмотрим, угу.
Клиент: Я уже здравствуй солнце пробовал. Мы такая редкая позицию то есть редко позиции.
Оператор: Ну и наш шоколад у вас цене не особо тут всего 19 тоже просмотров а видите, серый гранит э ну очень тоже красивый цвет тут тоже а 12 просмотров а скажите алмаз а вот если человек откладывает вы избранные вы никак с ним не пытаюсь я или сейчас контактировать не делали а рассылку скидок.
Клиент: То есть.
Оператор: Возможно тоже пробовали данную услугу.
Клиент: Нет-нет не пробовал ну это итак минимальный у вас спросить куда ещё скидка кто хочет подберёт так ставить.
Оператор: А ну вот я я и хотел спросить или у вас а цена фиксированная и вы не можете дальше снижать эту планку да.
Клиент: Да да фиксированная цена.
Оператор: Ага всё я бы сам не поняла а алмаз а я ведь правильно я понимаю что для вас важно эффективно использовать инструменты Avito для удержания клиентов.
Клиент: Ну да да да.
Оператор: Да.
Клиент: Ну поднятия не работают я бы сразу сказала какие есть какие тебе говорю.
Оператор: А нет спасибо за честность открытость вы то тоже нас меня поймите что наша цель не навязать вам никакую услугу алмаз а на то чтобы вы вышли на хороший товарооборот тогда мы останемся а вот в плюсе мы это не скрываем, а по поэтому мы и хотим чтобы у вас вот всё получилось а и вы сами были довольны своими продажами алмаз и последний вопрос я хотела.
Клиент: Ну да ну как когда. Когда оставишь слишком большую сумму слишком невыгодный установится продавать товар, если там допустим написала но чтобы обогнать конкурентов там сколько вот но надо поставить рублей 70 за 1 объявление просмотра это как минимум 90 я Абкадер.
Оператор: Угу. Угу.
Клиент: Человек просто заходят и тратить 70 рублей у нас тоже так ну Москвы, там человек возьмёт на 5000 ну посмотрите его, ну на 5000 там заработок пусть будет 15 процентов сколько но рублей 600 я заработаю а посмотрят не объявление допустим рубль но людей 10 12 то есть я потратил уже, я потрачу рублей 1000 и то есть я грубо говоря. Я грубо говоря бесплатно поработал потратил кучу времени.
Оператор: Да да. Отличный дорого получили. Тогда я вас поняла а алмаз А.
Клиент: Ну вам например.
Оператор: Угу, ай яй.
Клиент: Кто вот для примера.
Оператор: Ушлый услышала вас и не только я конечно вы же понимаете что разговор наш записывается специалисты прослушивают выявляет не только нарушение на ваши пожелания, а поэтому аа спасибо вам за вот и мысли за рекомендации которые мы слышим знаете как, и а вот даже какие-то претензии какие-то похвалы знаете вот все в едином, делаем и стараемся улучшить нашу площадку.
Клиент: Да ещё можете передать специалистам то что у меня это доставка почему-то работаете в каком-то чёрном списке похоже. Потому что у меня на какие-то объявление это работает на какие-то нет вот пусть они слушают и можете передать это так странно у других продавцов то есть.
Оператор: Но почему. А алло алло алло. А а мы можем можем сами, исправите вот в конце разговора если вам конечно удобно у меня есть такая возможность прям соединить вас со службой поддержкой и они посмотрят вы скажете какой объявление по им прямо на линии не смогут вам подсказать что можно сделать.
Клиент: Почему то работать меня нет. Я писал сообщение они не в итоге не решили эту проблему.
Оператор: Я так новый это вы писали а на линии они прямо зайдут и скажут вам причину.
Клиент: Ну можете давайте послушаю.
Оператор: Да-а а я вас соединю вопросы хотела который, а алмаз а скажите вот я вижу вам тоже доступна работающие инструменты наши подписки возможность тоже использовали есть у нас расширенная и максимальная подписку.
Клиент: Это там, Дмитриевна чтобы этот всё так оставить.
Оператор: А да ну, или нет тут идёт и вскрытие конкурентов в рекомендациях вот с этим инструментов блок.
Клиент: Красиво оформление. Нет-нет нет не надо я я так понял что это вообще нет не подходит.
Оператор: А они подходят а по какой причине август а дорого или а вы считаете что это не будет срабатывать.
Клиент: Ну и дорого но не стоит своих денег не будет срабатывать я как бы вот сам сижу если мне что-то назовите далее я даже так вообще.
Оператор: Ага я вас для него в любом случае если ознакамливались с этой информацией а как вы решили так вы и работаете а алмаз а тогда я с вами прощаюсь но вы трубку не кладите а я вас, сейчас попробую соединить э вот у вас там блокировка да, ага со службой поддержкой вам всего доброго хороших продаж и лояльных клиентов всего доброго до свидания.
Клиент: Я страницу на страницу счёта. Угу спасибо. Спасибо спасибо до свидания.
Оператор: Пожалуйста подождите вам ответит 1й освободившийся оператор. Здравствуйте служба поддержки Avito меня зовут Виктория чем я могу вам помочь.
Клиент: Да да здравствуйте. Хотел спросить а почему у меня вот на некоторые не работает. Avito доставка некоторое явление.
Оператор: Номер через минутку обращайтесь произошло в профиль в котором Юлия нервы уточните.
Клиент: Что ещё вас плохо слышно.
Оператор: Номер телефона с которого звоните привязан к профилю в котором вы размещаете объявления.
Клиент: Да да да да да.
Оператор: С каких объявлениях не работает доставка.
Клиент: Так ну вот, значит всё допустим. Ну поменять объявлению вот а элемент допустим его нельзя отправить он хотя бы малогабаритней. Парни изолента.
Оператор: Какой объект.
Клиент: Ну вот сам последний элемент коньках.
Оператор: Р элемент коньках коричневый.
Клиент: Да-да-да.
Оператор: На линии сейчас соединю по вашему вопросу специалистом.
Клиент: Ещё другие объявления вам сказать.
Оператор: По любому. Здравствуйте служба поддержки Avito меня зовут Данил чем я могу вам.
Клиент: Здравствуйте я уже только что с девушкой разговаривал.
Оператор: Да она переключила на меня. Какой вопрос.
Клиент: Я хотела спросить почему вот на некоторых объявление этот Avito доставка не работают.
Оператор: А так а можете подсказать. Какое объявление.
Клиент: Ну давайте начнём с которой у меня во-первых допустим эти скотчем почему вот вскочит почему я не готов дать.
Оператор: Код.
Клиент: Ну просто например.
Оператор: Ага да я сейчас посмотрю. Выставка включено. Это скотч для кровельных плёнок да.
Клиент: Ну как-то странно работает. Да-да-да.
Оператор: Например угу.
Клиент: Ну то есть товар так и не до Бориса стандартный.
Оператор: А так, а какие у него ну размеры вес. Это не он небольшой или большое но большое катушка.
Клиент: Да нет небольшая я встала с размером сейчас скажу.
Оператор: Ну примерно там килограмм 5 кило 6 килограмм да ага я понял.
Клиент: Нет такого нет-нет не килограмм 6 грамм. 300 нужно.
Оператор: А меня вообще я понял вообще, маленькие.
Клиент: Обычный искусства есть вот такой интернет такой скучно вам 2 раза больше наверное просто всё в диаметре. По систему.
Оператор: Да у вас нет доставки потому что, а стоит, категория.
Клиент: 15й.
Оператор: Ленты называется она подразумевает, товары большим объёмом ну там от 50 килограмм. Поэтому доставка только-только силами продавца доступна а вам нужно изменить категорию.
Клиент: Короче, не работает то это такой надо категориями нет.
Оператор: А Да-а нужно изменить категорию я сейчас смотрю куда лучше. Можно например добавить а ну также где она у вас находится только поменять. Последнюю под категорию место лент а там например пеной герметике, а тогда у вас и ну и Avito доставкой Яндекс доставка будут работать почта России СДЭК ну то есть все доставки через которое мы. Работаем. Сейчас ещё проверю что можно.
Клиент: Настой я понял понял тогда всё тогда я посмотрю, спасибо больше подходит спасибо большое.
Оператор: Угу. Всё. Хорошо не за что до свидания всего доброго.
Клиент: До свидания."""
    
    print("🧪 Testing Entity Extraction Quality Comparison")
    print("=" * 60)
    
    # Initialize configuration
    config_manager = ConfigManager()
    
    print("📝 Test Dialog Length:", len(test_dialog), "characters")
    print("📝 Test Dialog Preview:", test_dialog[:200] + "...")
    print()
    
    # Test enhanced extractor (async)
    print("🔍 Testing Enhanced Entity Extractor...")
    enhanced_extractor = EnhancedEntityExtractor(config_manager)
    
    try:
        # Run async function
        loop = asyncio.new_event_loop()
        asyncio.set_event_loop(loop)
        enhanced_result = loop.run_until_complete(enhanced_extractor._extract_entities_enhanced(test_dialog, 1))
        loop.close()
        
        print("✅ Enhanced extraction completed")
        
        if enhanced_result['extraction_success']:
            print("📊 Enhanced Results:")
            for entity_type, entities in enhanced_result['entities'].items():
                print(f"  {entity_type}: {len(entities)} entities")
                for entity in entities[:2]:  # Show first 2 (they're more detailed)
                    if isinstance(entity, dict):
                        print(f"    - {entity.get('описание', str(entity))}")
                        if 'контекст' in entity:
                            print(f"      Контекст: {entity['контекст']}")
                        if 'категория' in entity:
                            print(f"      Категория: {entity['категория']}")
                    else:
                        print(f"    - {entity}")
                if len(entities) > 2:
                    print(f"    ... and {len(entities) - 2} more")
        else:
            print("❌ Enhanced extraction failed")
            
    except Exception as e:
        print(f"❌ Enhanced extraction error: {e}")
        enhanced_result = None
    
    print()
    print("=" * 60)
    print("📈 Quality Analysis:")
    
    if enhanced_result and enhanced_result['extraction_success']:
        print("✅ Enhanced extractor succeeded")
        
        # Count entities
        enhanced_count = sum(len(entities) for entities in enhanced_result['entities'].values())
        print(f"📊 Total entities extracted: {enhanced_count}")
        
        # Analyze specific categories
        problems = enhanced_result['entities'].get('проблемы', [])
        delivery = enhanced_result['entities'].get('доставка', [])
        signals = enhanced_result['entities'].get('сигналы', [])
        
        print(f"\n🎯 Key Findings:")
        print(f"  Проблемы: {len(problems)} detailed issues")
        print(f"  Доставка: {len(delivery)} delivery-related items")
        print(f"  Сигналы: {len(signals)} business signals")
        
        # Show detailed analysis
        if problems:
            print(f"\n🔍 Detailed Problem Analysis:")
            for i, problem in enumerate(problems[:3], 1):
                if isinstance(problem, dict):
                    print(f"  {i}. {problem.get('описание', 'N/A')}")
                    print(f"     Категория: {problem.get('категория', 'N/A')}")
                    print(f"     Контекст: {problem.get('контекст', 'N/A')}")
                    print(f"     Критичность: {problem.get('критичность', 'N/A')}")
        
        if delivery:
            print(f"\n🚚 Delivery Analysis:")
            for i, item in enumerate(delivery[:3], 1):
                if isinstance(item, dict):
                    print(f"  {i}. {item.get('служба', 'N/A')}")
                    print(f"     Статус: {item.get('статус', 'N/A')}")
                    print(f"     Детали: {item.get('детали', 'N/A')}")
        
        print(f"\n🎉 Quality Assessment:")
        print("✅ Structured extraction with context")
        print("✅ Detailed categorization")
        print("✅ Business-relevant insights")
        print("✅ Client-focused analysis")
        
    else:
        print("❌ Enhanced extraction failed")


if __name__ == "__main__":
    test_quality_comparison()
